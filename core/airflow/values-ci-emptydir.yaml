# KLDP Airflow Configuration - CI Optimized with emptyDir
# Ultra-minimal configuration for GitHub Actions with emptyDir volumes (no PVC delays)

# Airflow executor
executor: "KubernetesExecutor"

# Airflow image
images:
  airflow:
    repository: apache/airflow
    tag: "3.1.0-python3.12"
    pullPolicy: IfNotPresent

# Minimal webserver configuration
webserver:
  replicas: 1
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  defaultUser:
    enabled: true
    role: Admin
    username: admin
    email: admin@kldp.local
    firstName: Admin
    lastName: User
    password: admin
  service:
    type: NodePort
    ports:
      - name: airflow-ui
        port: 8080

# Minimal PostgreSQL configuration
postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: bitnami/postgresql
    tag: "latest"
  auth:
    enablePostgresUser: true
    postgresPassword: postgres
    username: airflow
    password: airflow
    database: airflow
  primary:
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "250m"
    persistence:
      enabled: false  # Use emptyDir for faster startup in CI

# Disable Redis (not needed with KubernetesExecutor)
redis:
  enabled: false

# DAGs configuration - use emptyDir for faster CI startup
dags:
  persistence:
    enabled: false  # Disable PVC, use emptyDir instead
  gitSync:
    enabled: false

# Logs configuration - use emptyDir for faster CI startup
logs:
  persistence:
    enabled: false  # Disable PVC, use emptyDir instead

# Minimal scheduler configuration
scheduler:
  replicas: 1
  resources:
    requests:
      memory: "256Mi"  # Increased for more reliable startup in CI
      cpu: "100m"
    limits:
      memory: "512Mi"  # Increased for more reliable startup in CI
      cpu: "250m"

# Disable triggerer to save resources
triggerer:
  enabled: false

# Disable API server to save resources (new in Airflow 3.x)
# Note: apiServer doesn't have an 'enabled' field, so we set replicas to 0
apiServer:
  replicas: 0

# Minimal worker pod configuration
workers:
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "250m"

# Database migrations
createUserJob:
  useHelmHooks: true
  applyCustomEnv: true

migrateDatabaseJob:
  useHelmHooks: true
  applyCustomEnv: true

# Minimal environment variables
env:
  - name: AIRFLOW__CORE__LOAD_EXAMPLES
    value: "False"  # Disable examples in CI to speed up
  - name: AIRFLOW__API__EXPOSE_CONFIG
    value: "True"
  - name: AIRFLOW__CORE__PARALLELISM
    value: "8"
  - name: AIRFLOW__CORE__MAX_ACTIVE_TASKS_PER_DAG
    value: "4"
  - name: AIRFLOW__SCHEDULER__MAX_TIS_PER_QUERY
    value: "8"

# Essential pip packages only
extraPipPackages:
  - "apache-airflow-providers-cncf-kubernetes>=9.0.0"

# Airflow configuration overrides
config:
  celery:
    worker_concurrency: 2
  core:
    dags_are_paused_at_creation: 'False'
    load_default_connections: 'True'
  api:
    expose_config: 'True'
  kubernetes_executor:
    namespace: airflow
    worker_container_repository: apache/airflow
    worker_container_tag: "3.1.0-python3.12"
    delete_worker_pods: 'True'
    delete_worker_pods_on_failure: 'False'

# Security context
securityContext:
  runAsUser: 50000
  fsGroup: 0

# Standard naming
useStandardNaming: true
