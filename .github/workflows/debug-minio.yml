name: Debug MinIO Installation

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ feat/add-prometheus-grafana ]  # Auto-run on this branch for debugging

jobs:
  debug-minio:
    name: Debug MinIO Setup
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Docker registry connectivity
        run: |
          echo "=== Testing Docker registry connectivity ==="
          echo "Checking connectivity to registry-1.docker.io..."
          curl -I https://registry-1.docker.io/v2/ || echo "Registry connectivity issue detected"
          echo ""
          echo "Checking DNS resolution..."
          nslookup registry-1.docker.io || echo "DNS resolution issue detected"
          echo ""

      - name: Inspect MinIO Helm chart
        run: |
          echo "=== Inspecting MinIO Helm chart ==="
          helm pull oci://registry-1.docker.io/bitnamicharts/minio --version 17.0.21 --untar
          echo ""
          echo "Chart.yaml contents:"
          cat minio/Chart.yaml
          echo ""
          echo "values.yaml image configuration:"
          grep -A 10 "^image:" minio/values.yaml || echo "No image section found"
          echo ""

      - name: Check available MinIO image tags
        run: |
          echo "=== Checking available MinIO image tags ==="
          echo "This will help us understand what tags actually exist"
          echo ""
          echo "Attempting to pull default image from chart..."
          docker pull bitnami/minio:latest || echo "Latest tag pull failed"
          echo ""
          echo "Attempting to pull specific tag from chart..."
          docker pull bitnami/minio:2025.7.23-debian-12-r3 || echo "Specific tag pull failed"
          echo ""
          echo "Listing local images:"
          docker images | grep minio || echo "No minio images found locally"
          echo ""

      - name: Start Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          container-runtime: containerd
          kubernetes-version: v1.28.3
          cpus: 2
          memory: 4000m
          wait: all
          start-args: '--delete-on-failure'

      - name: Verify Cluster
        run: |
          echo "=== Cluster info ==="
          kubectl cluster-info
          kubectl get nodes -o wide
          echo ""

      - name: Create storage namespace
        run: |
          kubectl create namespace storage
          kubectl get namespaces
          echo ""

      - name: Pre-pull MinIO images (if available)
        run: |
          echo "=== Attempting to pre-pull and load MinIO images ==="
          echo ""

          echo "Trying to pull bitnami/minio:latest..."
          if docker pull bitnami/minio:latest; then
            echo "✓ Successfully pulled bitnami/minio:latest"
            echo "Loading into Minikube..."
            minikube image load bitnami/minio:latest
          else
            echo "✗ Failed to pull bitnami/minio:latest"
          fi
          echo ""

          echo "Trying to pull bitnami/minio:2025.7.23-debian-12-r3..."
          if docker pull bitnami/minio:2025.7.23-debian-12-r3; then
            echo "✓ Successfully pulled bitnami/minio:2025.7.23-debian-12-r3"
            echo "Loading into Minikube..."
            minikube image load bitnami/minio:2025.7.23-debian-12-r3
          else
            echo "✗ Failed to pull bitnami/minio:2025.7.23-debian-12-r3"
          fi
          echo ""

          echo "Trying to pull bitnami/minio-client:latest..."
          if docker pull bitnami/minio-client:latest; then
            echo "✓ Successfully pulled bitnami/minio-client:latest"
            echo "Loading into Minikube..."
            minikube image load bitnami/minio-client:latest
          else
            echo "✗ Failed to pull bitnami/minio-client:latest"
          fi
          echo ""

          echo "Images in Minikube:"
          minikube image ls | grep minio || echo "No minio images in Minikube"
          echo ""

      - name: Install MinIO with verbose output
        run: |
          echo "=== Installing MinIO with CI-optimized configuration ==="
          echo "Using values file: core/storage/minio-values-ci.yaml"
          echo ""
          cat core/storage/minio-values-ci.yaml
          echo ""
          echo "Installing with Helm (verbose mode)..."
          helm install minio oci://registry-1.docker.io/bitnamicharts/minio \
            --namespace storage \
            --values core/storage/minio-values-ci.yaml \
            --version 17.0.21 \
            --wait \
            --timeout 10m \
            --debug
        timeout-minutes: 15

      - name: Check MinIO deployment status
        if: always()
        run: |
          echo "=== MinIO Deployment Status ==="
          echo ""
          echo "Pods:"
          kubectl get pods -n storage -o wide
          echo ""
          echo "Deployments:"
          kubectl get deployments -n storage
          echo ""
          echo "ReplicaSets:"
          kubectl get rs -n storage
          echo ""
          echo "Services:"
          kubectl get svc -n storage
          echo ""
          echo "Events:"
          kubectl get events -n storage --sort-by='.lastTimestamp'
          echo ""

      - name: Describe MinIO pods
        if: always()
        run: |
          echo "=== Describing MinIO pods ==="
          for pod in $(kubectl get pods -n storage -o name); do
            echo "════════════════════════════════════════"
            echo "Pod: $pod"
            echo "════════════════════════════════════════"
            kubectl describe -n storage $pod
            echo ""
          done

      - name: Check MinIO logs
        if: always()
        run: |
          echo "=== MinIO pod logs ==="
          kubectl logs -n storage -l app.kubernetes.io/name=minio --all-containers=true --tail=100 || echo "No logs available"
          echo ""

      - name: Check image pull secrets and policies
        if: always()
        run: |
          echo "=== Image Pull Configuration ==="
          echo ""
          echo "ServiceAccounts in storage namespace:"
          kubectl get sa -n storage
          echo ""
          echo "Default ServiceAccount details:"
          kubectl describe sa default -n storage
          echo ""
          echo "Checking for image pull secrets:"
          kubectl get secrets -n storage
          echo ""

      - name: Test alternative MinIO installation (Docker Hub vs Quay)
        if: failure()
        run: |
          echo "=== Testing alternative image sources ==="
          echo ""
          echo "Attempting to use quay.io/minio/minio instead..."

          cat > test-minio-values.yaml <<EOF
mode: standalone

auth:
  rootUser: minioadmin
  rootPassword: minioadmin

image:
  registry: quay.io
  repository: minio/minio
  tag: latest

resources:
  requests:
    memory: "128Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "200m"

persistence:
  enabled: false

service:
  type: NodePort

defaultBuckets: "datalake"
EOF

          echo "Test values file:"
          cat test-minio-values.yaml
          echo ""

          # Uninstall previous attempt
          helm uninstall minio -n storage || echo "No previous installation to remove"

          echo "Trying with quay.io image..."
          helm install minio oci://registry-1.docker.io/bitnamicharts/minio \
            --namespace storage \
            --values test-minio-values.yaml \
            --version 17.0.21 \
            --wait \
            --timeout 5m \
            --debug || echo "Alternative installation also failed"

          echo ""
          echo "Alternative installation pod status:"
          kubectl get pods -n storage -o wide
          echo ""

      - name: Final diagnostic summary
        if: always()
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "                   DIAGNOSTIC SUMMARY"
          echo "════════════════════════════════════════════════════════════"
          echo ""
          echo "Registry Connectivity:"
          curl -I https://registry-1.docker.io/v2/ && echo "✓ Registry reachable" || echo "✗ Registry unreachable"
          echo ""
          echo "Minikube Status:"
          minikube status
          echo ""
          echo "Minikube Images (filtered for minio):"
          minikube image ls | grep -i minio || echo "No MinIO images in Minikube"
          echo ""
          echo "Docker Images (filtered for minio):"
          docker images | grep -i minio || echo "No MinIO images in Docker"
          echo ""
          echo "Storage Namespace Pods:"
          kubectl get pods -n storage -o wide
          echo ""
          echo "Recent Events:"
          kubectl get events -n storage --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "════════════════════════════════════════════════════════════"
